<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi Perfil - SuperMercado</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="header-app">
    <div class="container">
      <div class="header-row">
        <div class="logo">
          <div class="logo-icon">
            <img src="/img/carritologo.png" alt="SuperMercado Logo" class="logo-img">
          </div>
          <div class="logo-text">
            <div class="title">SuperMercado</div>
            <div class="subtitle">Delivery Express</div>
          </div>
        </div>
        <div class="search-placeholder"></div>
        <nav class="icons">
          <a class="icon" href="/" title="Inicio">üè†</a>
          <a class="icon" id="themeToggle" title="Modo Nocturno">üåô</a>
          <a class="icon" id="ecoToggle" title="Modo Ecol√≥gico">üå±</a>
          <a class="icon admin-link hidden" href="/admin.html" title="Admin">üõ†Ô∏è</a>
          <a class="icon" id="cartIcon" title="Carrito">üõçÔ∏è <span id="cartCount">0</span></a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="profile-hero">
      <div class="profile-avatar">
        <div class="avatar-circle">üë§</div>
      </div>
      <div class="profile-info">
        <h1 id="userName">Usuario</h1>
        <p id="userEmail">usuario@ejemplo.com</p>
        <div class="profile-stats">
          <div class="stat-item">
            <span class="stat-number" id="totalOrders">0</span>
            <span class="stat-label">Pedidos</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="totalSpent">$0</span>
            <span class="stat-label">Gastado</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="avgOrder">$0</span>
            <span class="stat-label">Promedio</span>
          </div>
        </div>
        
        <div class="profile-actions">
          <button class="logout-btn" id="profileLogoutBtn">
            <span class="logout-icon">üö™</span>
            <span class="logout-text">Cerrar Sesi√≥n</span>
          </button>
        </div>
      </div>
    </section>

    <div class="profile-tabs">
      <button class="profile-tab active" id="historyTab">üìã Historial</button>
      <button class="profile-tab" id="statsTab">üìä Estad√≠sticas</button>
      <button class="profile-tab" id="expensesTab">üí∞ Gastos</button>
    </div>

    <!-- Historial de Compras -->
    <section id="historySection" class="profile-section">
      <div class="section-header">
        <h2>Historial de Compras</h2>
        <div class="section-icon">üìã</div>
      </div>
      <div id="ordersList" class="orders-list">
        <!-- Las √≥rdenes se cargar√°n aqu√≠ -->
      </div>
    </section>

    <!-- Estad√≠sticas -->
    <section id="statsSection" class="profile-section hidden">
      <div class="section-header">
        <h2>Estad√≠sticas de Compras</h2>
        <div class="section-icon">üìä</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üì¶</div>
          <div class="stat-content">
            <h3>Total de Pedidos</h3>
            <p id="totalOrdersCount">0</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-content">
            <h3>Total Gastado</h3>
            <p id="totalSpentAmount">$0.00</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <h3>Promedio por Pedido</h3>
            <p id="avgOrderValue">$0.00</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-content">
            <h3>√öltimo Pedido</h3>
            <p id="lastOrderDate">Nunca</p>
          </div>
        </div>
      </div>
      
      <div class="charts-grid">
        <div class="chart-card">
          <div class="stat-icon">üìà</div>
          <div class="stat-content">
            <h3>Tendencia Mensual</h3>
            <div id="monthlyChart" class="chart-container">
              <!-- Gr√°fico se generar√° aqu√≠ -->
            </div>
          </div>
        </div>
        <div class="chart-card">
          <div class="stat-icon">ü•ó</div>
          <div class="stat-content">
            <h3>Categor√≠as de Productos</h3>
            <div id="categoryChart" class="circular-chart-container">
              <!-- Gr√°fico circular se generar√° aqu√≠ -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Gestor de Gastos -->
    <section id="expensesSection" class="profile-section hidden">
      <div class="section-header">
        <h2>Gestor de Gastos</h2>
        <div class="section-icon">üí∞</div>
      </div>
      <div class="expenses-grid">
        <div class="expense-card budget-card">
          <h3>Presupuesto Mensual</h3>
          <div class="budget-controls">
            <input type="number" id="monthlyBudget" placeholder="Presupuesto mensual" min="0" step="0.01">
            <button class="btn primary" id="setBudget">Establecer</button>
          </div>
          <div class="budget-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="budgetProgress"></div>
            </div>
            <p id="budgetText">Presupuesto no establecido</p>
          </div>
        </div>
        <div class="expense-card analysis-card">
          <h3>An√°lisis de Gastos</h3>
          <div class="expense-analysis">
            <div class="analysis-item">
              <span>Gasto promedio por pedido:</span>
              <span id="avgExpense">$0</span>
            </div>
            <div class="analysis-item">
              <span>Pedidos este mes:</span>
              <span id="monthlyOrders">0</span>
            </div>
            <div class="analysis-item">
              <span>Gasto total este mes:</span>
              <span id="monthlyExpense">$0</span>
            </div>
          </div>
        </div>
        <div class="expense-card recommendations-card">
          <h3>üí° Recomendaciones</h3>
          <div id="recommendationsList" class="recommendations-list">
            <!-- Las recomendaciones se generar√°n aqu√≠ -->
          </div>
        </div>
        <div class="expense-card trends-card">
          <h3>üìà Tendencias de Gastos</h3>
          <div class="trends-content">
            <div class="trend-item">
              <div class="trend-icon">üìä</div>
              <div class="trend-info">
                <h4>Proyecci√≥n Mensual</h4>
                <p id="monthlyProjection">Basado en tus gastos actuales</p>
              </div>
            </div>
            <div class="trend-item">
              <div class="trend-icon">üéØ</div>
              <div class="trend-info">
                <h4>Meta de Ahorro</h4>
                <p id="savingsGoal">Calculando tu potencial de ahorro</p>
              </div>
            </div>
            <div class="trend-item">
              <div class="trend-icon">üìÖ</div>
              <div class="trend-info">
                <h4>D√≠as Restantes</h4>
                <p id="daysRemaining">D√≠as hasta fin de mes</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="/app.js"></script>
  <script>
    // Script espec√≠fico para la p√°gina de perfil
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar datos del usuario
      loadUserProfile();
      
      // Inicializar modo oscuro y eco
      initializeThemes();
      
      // Inicializar carrito
      initializeCart();
      
      // Event listeners para tabs
      document.getElementById('historyTab').addEventListener('click', () => showSection('history'));
      document.getElementById('statsTab').addEventListener('click', () => showSection('stats'));
      document.getElementById('expensesTab').addEventListener('click', () => showSection('expenses'));
      
      // Event listeners para gestor de gastos
      document.getElementById('setBudget').addEventListener('click', setMonthlyBudget);
      
      // Event listener para logout
      document.getElementById('profileLogoutBtn').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
          // Limpiar datos de autenticaci√≥n
          localStorage.removeItem('super_auth_v1');
          localStorage.removeItem('currentUserId');
          alert('Sesi√≥n cerrada correctamente');
          // Redirigir a la p√°gina principal
          window.location.href = '/';
        }
      });
      
      // Cargar presupuesto guardado
      loadBudget();
    });
    
    // Funci√≥n para inicializar temas
    function initializeThemes() {
      // Aplicar tema guardado
      const savedTheme = localStorage.getItem('super_theme_v1') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const savedEco = localStorage.getItem('super_eco_v1') === 'true';
      document.documentElement.setAttribute('data-eco', savedEco);
      
      // Event listeners para toggles
      document.getElementById('themeToggle')?.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('super_theme_v1', newTheme);
      });
      
      document.getElementById('ecoToggle')?.addEventListener('click', () => {
        const currentEco = document.documentElement.getAttribute('data-eco') === 'true';
        const newEco = !currentEco;
        document.documentElement.setAttribute('data-eco', newEco);
        localStorage.setItem('super_eco_v1', newEco);
      });
    }
    
    // Funci√≥n para inicializar carrito
    function initializeCart() {
      // Cargar contador del carrito
      updateCartBadge();
      
      // Event listener para el icono del carrito
      document.getElementById('cartIcon')?.addEventListener('click', () => {
        // Redirigir a la p√°gina principal con el carrito abierto
        window.location.href = '/?openCart=true';
      });
    }
    
    // Funci√≥n para actualizar el badge del carrito
    function updateCartBadge() {
      const badge = document.getElementById('cartCount');
      if (badge) {
        try {
          const cartData = localStorage.getItem('super_cart_v1');
          if (cartData) {
            const items = JSON.parse(cartData);
            const count = items.reduce((total, item) => total + (item.quantity || 0), 0);
            badge.textContent = count;
          } else {
            badge.textContent = '0';
          }
        } catch (error) {
          console.error('Error cargando carrito:', error);
          badge.textContent = '0';
        }
      }
    }
    
    function showSection(section) {
      // Ocultar todas las secciones
      document.querySelectorAll('.profile-section').forEach(s => s.classList.add('hidden'));
      document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
      
      // Mostrar secci√≥n seleccionada
      document.getElementById(section + 'Section').classList.remove('hidden');
      document.getElementById(section + 'Tab').classList.add('active');
      
      // Cargar datos espec√≠ficos de la secci√≥n
      if (section === 'stats') {
        loadStats();
      } else if (section === 'expenses') {
        loadExpenses();
      }
    }
    
    async function loadUserProfile() {
      const userId = localStorage.getItem('currentUserId');
      if (!userId) {
        window.location.href = '/';
        return;
      }
      
      try {
        const user = await fetch(`/api/users/${userId}`).then(r => r.json());
        document.getElementById('userName').textContent = user.name;
        document.getElementById('userEmail').textContent = user.email;
        
        // Cargar estad√≠sticas b√°sicas
        const stats = await fetch(`/api/orders/${userId}/stats`).then(r => r.json());
        document.getElementById('totalOrders').textContent = stats.total_orders || 0;
        document.getElementById('totalSpent').textContent = '$' + (stats.total_spent || 0).toFixed(2);
        document.getElementById('avgOrder').textContent = '$' + (stats.avg_order_value || 0).toFixed(2);
        document.getElementById('lastOrderDate').textContent = stats.last_order_date ? 
          new Date(stats.last_order_date).toLocaleDateString() : 'Nunca';
        
        // Cargar historial
        loadOrderHistory(userId);
      } catch (error) {
        console.error('Error cargando perfil:', error);
      }
    }
    
    async function loadOrderHistory(userId) {
      try {
        const orders = await fetch(`/api/orders/${userId}`).then(r => r.json());
        const ordersList = document.getElementById('ordersList');
        
        if (!orders || orders.length === 0) {
          ordersList.innerHTML = '<div class="empty-state">No tienes pedidos a√∫n</div>';
          return;
        }
        
        ordersList.innerHTML = orders.map(order => {
          const orderDate = new Date(order.created_at);
          const formattedDate = orderDate.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // Calcular cantidad de productos
          let itemsCount = 0;
          let itemsSummary = '';
          
          if (order.items_summary) {
            // Usar el resumen si est√° disponible
            itemsSummary = order.items_summary;
            // Contar productos del resumen
            itemsCount = (order.items_summary.match(/x\d+/g) || []).reduce((total, match) => {
              return total + parseInt(match.replace('x', ''));
            }, 0);
          } else if (order.items) {
            // Parsear JSON si est√° disponible
            try {
              const items = JSON.parse(order.items);
              itemsCount = items.reduce((total, item) => total + item.quantity, 0);
              itemsSummary = items.map(item => `${item.name} x${item.quantity}`).join(', ');
            } catch (e) {
              itemsCount = 0;
              itemsSummary = 'Productos no disponibles';
            }
          }
          
          return `
            <div class="order-item">
              <div class="order-header">
                <span class="order-id">Pedido #${order.id}</span>
                <span class="order-date">${formattedDate}</span>
                <span class="order-total">$${order.total.toFixed(2)}</span>
              </div>
              <div class="order-items">
                <div class="order-status">Estado: ${order.status === 'completed' ? 'Completado' : order.status}</div>
                <div class="order-summary">${itemsCount} productos</div>
                <div class="order-details">${itemsSummary}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error cargando historial:', error);
        const ordersList = document.getElementById('ordersList');
        ordersList.innerHTML = '<div class="empty-state">Error cargando el historial de pedidos</div>';
      }
    }
    
    async function loadStats() {
      const userId = localStorage.getItem('currentUserId');
      if (!userId) return;
      
      try {
        const stats = await fetch(`/api/orders/${userId}/stats`).then(r => r.json());
        
        // Actualizar estad√≠sticas b√°sicas
        document.getElementById('totalOrdersCount').textContent = stats.total_orders || 0;
        document.getElementById('totalSpentAmount').textContent = '$' + (stats.total_spent || 0).toFixed(2);
        document.getElementById('avgOrderValue').textContent = '$' + (stats.avg_order_value || 0).toFixed(2);
        document.getElementById('lastOrderDate').textContent = stats.last_order_date ? 
          new Date(stats.last_order_date).toLocaleDateString('es-ES') : 'Nunca';
        
        // Generar gr√°fico simple de gastos mensuales
        const chartContainer = document.getElementById('monthlyChart');
        if (chartContainer) {
          if (stats.monthlyStats && stats.monthlyStats.length > 0) {
            const maxSpent = Math.max(...stats.monthlyStats.map(m => m.total_spent));
            
            chartContainer.innerHTML = `
              <div class="chart-header">
                <h4>Evoluci√≥n de Gastos Mensuales</h4>
                <div class="chart-subtitle">Comparaci√≥n mes a mes</div>
              </div>
              <div class="chart-bars">
                ${stats.monthlyStats.map((month, index) => {
                  const height = maxSpent > 0 ? (month.total_spent / maxSpent) * 100 : 0;
                  const monthName = new Date(month.month + '-01').toLocaleDateString('es-ES', { month: 'short' });
                  const year = month.month.split('-')[0];
                  const isCurrentMonth = index === 0;
                  
                  return `
                    <div class="chart-bar">
                      <div class="bar-container">
                        <div class="bar" style="height: ${height}%" title="$${month.total_spent.toFixed(2)} en ${monthName} ${year}"></div>
                        <div class="bar-value-overlay">$${month.total_spent.toFixed(2)}</div>
                      </div>
                      <span class="bar-label">${monthName}</span>
                      <span class="bar-year">${year}</span>
                      ${isCurrentMonth ? '<span class="current-month">Actual</span>' : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          } else {
            chartContainer.innerHTML = '<div class="empty-state">No hay datos suficientes para mostrar el gr√°fico</div>';
          }
        }
        
        // Generar gr√°fico circular de categor√≠as
        loadCategoryChart(userId);
        
      } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
        const chartContainer = document.getElementById('monthlyChart');
        if (chartContainer) {
          chartContainer.innerHTML = '<div class="empty-state">Error cargando estad√≠sticas</div>';
        }
      }
    }
    
    async function loadCategoryChart(userId) {
      try {
        // Obtener √≥rdenes del usuario para analizar categor√≠as
        const orders = await fetch(`/api/orders/${userId}`).then(r => r.json());
        const categoryChart = document.getElementById('categoryChart');
        
        if (!orders || orders.length === 0) {
          categoryChart.innerHTML = '<div class="empty-state">No hay datos suficientes para mostrar el gr√°fico</div>';
          return;
        }
        
        // Analizar categor√≠as de productos comprados
        const categoryStats = {};
        let totalProducts = 0;
        
        orders.forEach(order => {
          if (order.items_summary) {
            // Parsear items_summary (formato: "Producto x1 ($precio), Producto x2 ($precio)")
            const items = order.items_summary.split(', ');
            items.forEach(item => {
              const match = item.match(/^(.+?)\s+x(\d+)/);
              if (match) {
                const productName = match[1].toLowerCase();
                const quantity = parseInt(match[2]);
                
                // Categorizaci√≥n mejorada
                let category = 'Otros';
                if (productName.includes('manzana') || productName.includes('banana') || productName.includes('naranja') || productName.includes('fresa') || productName.includes('uva') || productName.includes('fruta')) {
                  category = 'Frutas';
                } else if (productName.includes('leche') || productName.includes('queso') || productName.includes('yogur') || productName.includes('l√°cteo')) {
                  category = 'L√°cteos';
                } else if (productName.includes('pan') || productName.includes('galleta') || productName.includes('torta') || productName.includes('panader√≠a')) {
                  category = 'Panader√≠a';
                } else if (productName.includes('huevo')) {
                  category = 'Huevos';
                } else if (productName.includes('agua') || productName.includes('jugo') || productName.includes('bebida') || productName.includes('t√©') || productName.includes('refresco')) {
                  category = 'Bebidas';
                } else if (productName.includes('verdura') || productName.includes('vegetal') || productName.includes('lechuga') || productName.includes('tomate')) {
                  category = 'Verduras';
                } else if (productName.includes('carne') || productName.includes('pollo') || productName.includes('pescado') || productName.includes('jam√≥n')) {
                  category = 'Carnes';
                }
                
                if (!categoryStats[category]) {
                  categoryStats[category] = 0;
                }
                categoryStats[category] += quantity;
                totalProducts += quantity;
              }
            });
          } else if (order.items) {
            // Parsear JSON si est√° disponible
            try {
              const items = JSON.parse(order.items);
              items.forEach(item => {
                let category = 'Otros';
                const productName = item.name.toLowerCase();
                
                if (productName.includes('manzana') || productName.includes('banana') || productName.includes('naranja') || productName.includes('fresa') || productName.includes('uva')) {
                  category = 'Frutas';
                } else if (productName.includes('leche') || productName.includes('queso') || productName.includes('yogur')) {
                  category = 'L√°cteos';
                } else if (productName.includes('pan') || productName.includes('galleta') || productName.includes('torta')) {
                  category = 'Panader√≠a';
                } else if (productName.includes('huevo')) {
                  category = 'Huevos';
                } else if (productName.includes('agua') || productName.includes('jugo') || productName.includes('bebida')) {
                  category = 'Bebidas';
                }
                
                if (!categoryStats[category]) {
                  categoryStats[category] = 0;
                }
                categoryStats[category] += item.quantity;
                totalProducts += item.quantity;
              });
            } catch (e) {
              console.error('Error parsing order items:', e);
            }
          }
        });
        
        if (totalProducts === 0) {
          categoryChart.innerHTML = '<div class="empty-state">No hay productos para mostrar</div>';
          return;
        }
        
        // Generar gr√°fico circular con l√≥gica corregida
        const colors = ['#14b8a6', '#ff6b5a', '#22c55e', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#84cc16'];
        const categories = Object.keys(categoryStats);
        
        // Ordenar categor√≠as por cantidad (mayor a menor) para mejor visualizaci√≥n
        const sortedCategories = categories.sort((a, b) => categoryStats[b] - categoryStats[a]);
        
        let currentAngle = 0;
        const radius = 80;
        const centerX = 110;
        const centerY = 110;
        
        // Crear c√≠rculos para cada categor√≠a con c√°lculo correcto de √°ngulos
        const svgCircles = sortedCategories.map((category, index) => {
          const count = categoryStats[category];
          const percentage = (count / totalProducts) * 100;
          const angle = (percentage / 100) * 360;
          const circumference = 2 * Math.PI * radius;
          const strokeDasharray = `${(angle / 360) * circumference} ${circumference}`;
          
          // Calcular el offset correcto
          const offset = -currentAngle * circumference / 360;
          
          const circle = `<circle 
            class="progress" 
            cx="${centerX}" 
            cy="${centerY}" 
            r="${radius}" 
            stroke="${colors[index % colors.length]}" 
            stroke-dasharray="${strokeDasharray}" 
            stroke-dashoffset="${offset}"
            data-category="${category}"
            data-count="${count}"
            data-percentage="${percentage.toFixed(1)}"
          />`;
          
          currentAngle += angle;
          return circle;
        }).join('');
        
        // Crear leyenda con colores correctos
        const legend = sortedCategories.map((category, index) => `
          <div class="circular-legend-item">
            <div class="circular-legend-color" style="background: ${colors[index % colors.length]}"></div>
            <span>${category} (${categoryStats[category]})</span>
          </div>
        `).join('');
        
        categoryChart.innerHTML = `
          <div class="circular-chart">
            <svg width="220" height="220">
              <circle class="background" cx="${centerX}" cy="${centerY}" r="${radius}" />
              ${svgCircles}
            </svg>
            <div class="chart-center">
              <div class="chart-center-value">${totalProducts}</div>
              <div class="chart-center-label">productos</div>
            </div>
          </div>
          <div class="circular-legend">
            ${legend}
          </div>
        `;
        
        // Agregar interactividad mejorada
        const chartSvg = categoryChart.querySelector('svg');
        const circles = chartSvg.querySelectorAll('.progress');
        
        circles.forEach(circle => {
          circle.addEventListener('mouseenter', function() {
            const category = this.getAttribute('data-category');
            const count = this.getAttribute('data-count');
            const percentage = this.getAttribute('data-percentage');
            
            // Resaltar el c√≠rculo
            this.style.strokeWidth = '20';
            this.style.filter = 'drop-shadow(0 0 8px rgba(0,0,0,0.3))';
            
            // Mostrar tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'chart-tooltip';
            tooltip.innerHTML = `
              <strong>${category}</strong><br>
              ${count} productos (${percentage}%)
            `;
            tooltip.style.position = 'absolute';
            tooltip.style.background = 'var(--card)';
            tooltip.style.border = '1px solid var(--line)';
            tooltip.style.borderRadius = '8px';
            tooltip.style.padding = '8px 12px';
            tooltip.style.fontSize = '12px';
            tooltip.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            tooltip.style.zIndex = '1000';
            tooltip.style.pointerEvents = 'none';
            
            document.body.appendChild(tooltip);
            
            // Posicionar tooltip
            const rect = this.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
            
            this.tooltip = tooltip;
            
            // Resaltar en la leyenda
            const legendItems = categoryChart.querySelectorAll('.circular-legend-item');
            legendItems.forEach(item => {
              if (item.textContent.includes(category)) {
                item.style.fontWeight = '700';
                item.style.transform = 'scale(1.05)';
                item.style.color = 'var(--text)';
              }
            });
          });
          
          circle.addEventListener('mouseleave', function() {
            // Quitar resaltado del c√≠rculo
            this.style.strokeWidth = '16';
            this.style.filter = 'none';
            
            // Remover tooltip
            if (this.tooltip) {
              document.body.removeChild(this.tooltip);
              this.tooltip = null;
            }
            
            // Quitar resaltado de la leyenda
            const legendItems = categoryChart.querySelectorAll('.circular-legend-item');
            legendItems.forEach(item => {
              item.style.fontWeight = '500';
              item.style.transform = 'scale(1)';
              item.style.color = 'var(--muted)';
            });
          });
        });
        
      } catch (error) {
        console.error('Error cargando gr√°fico de categor√≠as:', error);
        const categoryChart = document.getElementById('categoryChart');
        if (categoryChart) {
          categoryChart.innerHTML = '<div class="empty-state">Error cargando gr√°fico de categor√≠as</div>';
        }
      }
    }
    
    function loadExpenses() {
      const userId = localStorage.getItem('currentUserId');
      if (!userId) return;
      
      // Cargar datos de gastos del localStorage
      const budget = localStorage.getItem(`budget_${userId}`);
      if (budget) {
        document.getElementById('monthlyBudget').value = budget;
        updateBudgetDisplay();
      }
      
      // Cargar estad√≠sticas de gastos desde la API
      loadExpenseStats(userId);
    }
    
    async function loadExpenseStats(userId) {
      try {
        const stats = await fetch(`/api/orders/${userId}/stats`).then(r => r.json());
        
        // Actualizar estad√≠sticas de gastos
        const monthlySpent = stats.monthlyStats && stats.monthlyStats.length > 0 ? 
          stats.monthlyStats[0].total_spent : 0;
        
        document.getElementById('monthlyExpense').textContent = '$' + monthlySpent.toFixed(2);
        document.getElementById('monthlyOrders').textContent = stats.monthlyStats && stats.monthlyStats.length > 0 ? 
          stats.monthlyStats[0].orders_count : 0;
        document.getElementById('avgExpense').textContent = '$' + (stats.avg_order_value || 0).toFixed(2);
        
        // Generar recomendaciones inteligentes
        generateRecommendations(stats, monthlySpent, stats.monthlyStats && stats.monthlyStats.length > 0 ? 
          stats.monthlyStats[0].orders_count : 0);
        
        // Generar tendencias de gastos
        generateExpenseTrends(stats, monthlySpent, monthlyOrders);
        
        // Actualizar presupuesto si existe
        const budget = localStorage.getItem(`budget_${userId}`);
        if (budget) {
          const budgetAmount = parseFloat(budget);
          const remaining = budgetAmount - monthlySpent;
          document.getElementById('budgetRemaining').textContent = '$' + remaining.toFixed(2);
          
          // Cambiar color seg√∫n el presupuesto
          const remainingElement = document.getElementById('budgetRemaining');
          if (remaining < 0) {
            remainingElement.style.color = '#ef4444'; // Rojo si se excedi√≥
          } else if (remaining < budgetAmount * 0.2) {
            remainingElement.style.color = '#f59e0b'; // Amarillo si queda poco
          } else {
            remainingElement.style.color = '#22c55e'; // Verde si est√° bien
          }
        }
      } catch (error) {
        console.error('Error cargando estad√≠sticas de gastos:', error);
      }
    }
    
    function generateRecommendations(stats, monthlySpent, monthlyOrders) {
      const recommendationsList = document.getElementById('recommendationsList');
      const recommendations = [];
      
      // Obtener presupuesto del usuario
      const userId = localStorage.getItem('currentUserId');
      const budget = localStorage.getItem(`budget_${userId}`);
      const budgetAmount = budget ? parseFloat(budget) : 0;
      
      // Recomendaci√≥n 1: Presupuesto
      if (budgetAmount > 0) {
        const budgetUsage = (monthlySpent / budgetAmount) * 100;
        
        if (budgetUsage > 90) {
          recommendations.push({
            icon: '‚ö†Ô∏è',
            title: 'Presupuesto casi agotado',
            text: `Has gastado el ${budgetUsage.toFixed(1)}% de tu presupuesto mensual. Considera reducir gastos o ajustar tu presupuesto.`,
            priority: 'high'
          });
        } else if (budgetUsage > 75) {
          recommendations.push({
            icon: 'üí°',
            title: 'Presupuesto en zona de atenci√≥n',
            text: `Has gastado el ${budgetUsage.toFixed(1)}% de tu presupuesto. Te quedan $${(budgetAmount - monthlySpent).toFixed(2)} para el resto del mes.`,
            priority: 'medium'
          });
        } else if (budgetUsage < 30) {
          recommendations.push({
            icon: '‚úÖ',
            title: 'Excelente control de gastos',
            text: `Solo has gastado el ${budgetUsage.toFixed(1)}% de tu presupuesto. ¬°Sigue as√≠!`,
            priority: 'low'
          });
        }
      } else {
        recommendations.push({
          icon: 'üìä',
          title: 'Establece un presupuesto',
          text: 'Configura un presupuesto mensual para tener mejor control de tus gastos y recibir recomendaciones personalizadas.',
          priority: 'medium'
        });
      }
      
      // Recomendaci√≥n 2: Frecuencia de pedidos
      if (monthlyOrders > 10) {
        recommendations.push({
          icon: 'üõí',
          title: 'Muchos pedidos peque√±os',
          text: `Has hecho ${monthlyOrders} pedidos este mes. Considera hacer pedidos m√°s grandes para ahorrar en env√≠os.`,
          priority: 'medium'
        });
      } else if (monthlyOrders < 2 && monthlySpent > 0) {
        recommendations.push({
          icon: 'üí™',
          title: 'Pedidos eficientes',
          text: 'Haces pocos pedidos pero con buen valor. ¬°Excelente estrategia de compra!',
          priority: 'low'
        });
      }
      
      // Recomendaci√≥n 3: Valor promedio
      const avgOrderValue = stats.avg_order_value || 0;
      if (avgOrderValue < 5) {
        recommendations.push({
          icon: 'üí∞',
          title: 'Pedidos de bajo valor',
          text: 'Tus pedidos tienen un valor promedio bajo. Considera agregar m√°s productos para aprovechar mejor los env√≠os.',
          priority: 'low'
        });
      } else if (avgOrderValue > 50) {
        recommendations.push({
          icon: 'üéØ',
          title: 'Pedidos de alto valor',
          text: 'Tus pedidos tienen un valor promedio alto. ¬°Excelente para aprovechar ofertas y descuentos!',
          priority: 'low'
        });
      }
      
      // Recomendaci√≥n 4: Tendencia temporal
      if (stats.monthlyStats && stats.monthlyStats.length > 1) {
        const currentMonth = stats.monthlyStats[0].total_spent;
        const previousMonth = stats.monthlyStats[1].total_spent;
        const change = ((currentMonth - previousMonth) / previousMonth) * 100;
        
        if (change > 50) {
          recommendations.push({
            icon: 'üìà',
            title: 'Aumento significativo en gastos',
            text: `Tus gastos aumentaron ${change.toFixed(1)}% respecto al mes anterior. Revisa si es necesario ajustar tu presupuesto.`,
            priority: 'high'
          });
        } else if (change < -30) {
          recommendations.push({
            icon: 'üìâ',
            title: 'Reducci√≥n notable en gastos',
            text: `Tus gastos disminuyeron ${Math.abs(change).toFixed(1)}% respecto al mes anterior. ¬°Excelente trabajo!`,
            priority: 'low'
          });
        }
      }
      
      // Recomendaci√≥n 5: Productos eco
      recommendations.push({
        icon: 'üå±',
        title: 'Compra productos eco',
        text: 'Considera agregar m√°s productos ecol√≥gicos a tus pedidos. Son mejores para el medio ambiente y tu salud.',
        priority: 'low'
      });
      
      // Recomendaci√≥n 6: D√≠as de la semana
      const today = new Date();
      const dayOfWeek = today.getDay();
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        recommendations.push({
          icon: 'üìÖ',
          title: 'Fin de semana inteligente',
          text: 'Los fines de semana son ideales para hacer pedidos m√°s grandes y planificar la semana. Aprovecha para ahorrar en env√≠os.',
          priority: 'low'
        });
      }
      
      // Recomendaci√≥n 7: Horario de compra
      const hour = today.getHours();
      if (hour >= 9 && hour <= 11) {
        recommendations.push({
          icon: '‚è∞',
          title: 'Horario √≥ptimo',
          text: 'Est√°s comprando en un horario ideal. Las entregas matutinas suelen ser m√°s r√°pidas y confiables.',
          priority: 'low'
        });
      }
      
      // Recomendaci√≥n 8: Estacionalidad
      const month = today.getMonth();
      if (month >= 5 && month <= 8) {
        recommendations.push({
          icon: '‚òÄÔ∏è',
          title: 'Temporada de verano',
          text: 'En verano, considera comprar m√°s frutas frescas y bebidas. Es la temporada ideal para productos hidratantes.',
          priority: 'low'
        });
      } else if (month >= 11 || month <= 1) {
        recommendations.push({
          icon: '‚ùÑÔ∏è',
          title: 'Temporada de invierno',
          text: 'En invierno, considera productos que se conserven bien y bebidas calientes. Planifica compras m√°s grandes.',
          priority: 'low'
        });
      }
      
      // Recomendaci√≥n 9: Comparaci√≥n con promedio general
      if (avgOrderValue > 15) {
        recommendations.push({
          icon: 'üíé',
          title: 'Comprador premium',
          text: 'Tus pedidos tienen un valor alto. Considera programas de fidelidad o descuentos por volumen.',
          priority: 'low'
        });
      }
      
      // Recomendaci√≥n 10: Frecuencia √≥ptima
      const daysSinceLastOrder = stats.last_order_date ? 
        Math.floor((new Date() - new Date(stats.last_order_date)) / (1000 * 60 * 60 * 24)) : 0;
      
      if (daysSinceLastOrder > 7) {
        recommendations.push({
          icon: '‚è≥',
          title: 'Tiempo sin comprar',
          text: `Han pasado ${daysSinceLastOrder} d√≠as desde tu √∫ltimo pedido. Considera hacer una compra para mantener productos frescos.`,
          priority: 'medium'
        });
      } else if (daysSinceLastOrder < 2) {
        recommendations.push({
          icon: 'üõí',
          title: 'Comprador frecuente',
          text: 'Haces compras muy frecuentes. Considera hacer pedidos m√°s grandes para optimizar costos de env√≠o.',
          priority: 'medium'
        });
      }
      
      // Mostrar recomendaciones
      if (recommendations.length === 0) {
        recommendationsList.innerHTML = '<div class="empty-state">No hay recomendaciones disponibles en este momento</div>';
      } else {
        recommendationsList.innerHTML = recommendations.map(rec => `
          <div class="recommendation-item">
            <div class="recommendation-icon">${rec.icon}</div>
            <div class="recommendation-content">
              <div class="recommendation-title">${rec.title}</div>
              <div class="recommendation-text">${rec.text}</div>
            </div>
            <div class="recommendation-priority priority-${rec.priority}">
              ${rec.priority === 'high' ? 'Alta' : rec.priority === 'medium' ? 'Media' : 'Baja'}
            </div>
          </div>
        `).join('');
      }
    }
    
    function generateExpenseTrends(stats, monthlySpent, monthlyOrders) {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysPassed = today.getDate();
      const daysRemaining = daysInMonth - daysPassed;
      
      // Proyecci√≥n mensual
      const dailyAverage = monthlySpent / daysPassed;
      const projectedMonthly = dailyAverage * daysInMonth;
      
      // Meta de ahorro
      const userId = localStorage.getItem('currentUserId');
      const budget = localStorage.getItem(`budget_${userId}`);
      const budgetAmount = budget ? parseFloat(budget) : 0;
      
      let savingsGoal = '';
      if (budgetAmount > 0) {
        const potentialSavings = budgetAmount - projectedMonthly;
        if (potentialSavings > 0) {
          savingsGoal = `Puedes ahorrar $${potentialSavings.toFixed(2)} este mes`;
        } else {
          savingsGoal = `Necesitas ajustar tu presupuesto en $${Math.abs(potentialSavings).toFixed(2)}`;
        }
      } else {
        savingsGoal = 'Establece un presupuesto para calcular tu potencial de ahorro';
      }
      
      // Actualizar elementos
      document.getElementById('monthlyProjection').textContent = 
        `Proyecci√≥n: $${projectedMonthly.toFixed(2)} (promedio diario: $${dailyAverage.toFixed(2)})`;
      
      document.getElementById('savingsGoal').textContent = savingsGoal;
      
      document.getElementById('daysRemaining').textContent = 
        `${daysRemaining} d√≠as restantes en ${today.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
    }
    
    function setMonthlyBudget() {
      const budget = document.getElementById('monthlyBudget').value;
      const userId = localStorage.getItem('currentUserId');
      
      if (!budget || budget <= 0) {
        alert('Por favor ingresa un presupuesto v√°lido');
        return;
      }
      
      localStorage.setItem(`budget_${userId}`, budget);
      updateBudgetDisplay();
      alert('Presupuesto establecido correctamente');
    }
    
    function loadBudget() {
      const userId = localStorage.getItem('currentUserId');
      const budget = localStorage.getItem(`budget_${userId}`);
      if (budget) {
        document.getElementById('monthlyBudget').value = budget;
        updateBudgetDisplay();
      }
    }
    
    async function updateBudgetDisplay() {
      const userId = localStorage.getItem('currentUserId');
      const budget = localStorage.getItem(`budget_${userId}`);
      
      if (!budget) return;
      
      try {
        const stats = await fetch(`/api/orders/${userId}/stats`).then(r => r.json());
        const monthlySpent = stats.monthlyStats && stats.monthlyStats.length > 0 ? 
          stats.monthlyStats[0].total_spent : 0;
        
        const percentage = (monthlySpent / budget) * 100;
        const progressFill = document.getElementById('budgetProgress');
        const budgetText = document.getElementById('budgetText');
        
        progressFill.style.width = Math.min(percentage, 100) + '%';
        progressFill.style.backgroundColor = percentage > 80 ? '#ef4444' : percentage > 60 ? '#f59e0b' : '#10b981';
        
        budgetText.textContent = `$${monthlySpent.toFixed(2)} de $${budget} (${percentage.toFixed(1)}%)`;
        
        // Actualizar an√°lisis
        document.getElementById('avgExpense').textContent = '$' + (stats.avg_order_value || 0).toFixed(2);
        document.getElementById('monthlyOrders').textContent = stats.monthlyStats && stats.monthlyStats.length > 0 ? 
          stats.monthlyStats[0].orders_count : 0;
        document.getElementById('monthlyExpense').textContent = '$' + monthlySpent.toFixed(2);
      } catch (error) {
        console.error('Error actualizando presupuesto:', error);
      }
    }
  </script>
</body>
</html>
